---
title: "survRatio"
output:
  html_document: default
vignette: >
  %\VignetteIndexEntry{"survRatio"}
  %\VignetteEngine{knitr::knitr}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# The survRatio package
## Estimating, Comparing and Visualising Time to Event Data

The `survRatio` is an R package which provides numerical and graphical summaries for time to event data. In this release functions are provided to estimate and compare estimated survivor functions ($S_1(t),S_2(t)$), the ratio of survivor functions ($\frac{S_1(t)}{S_2(t)}$) and the difference of survivor functions ($S_1(t)-S_2(t)$) in independent and paired time to event problems. Time intervals where the survival prospects may differ are identified using pointwise confidence bands [1]. 

### Example 1: Independent survival data

The lung cancer dataset from the `survival` package includes the survival time (in days) of male and female patients with advanced lung cancer from the North Central Cancer Treatment Group. These data are used to illustrate the comparison of two (independent) survivor functions.

```{r, include=F}
library(knitr)
library(survival)
library(ggplot2)
library(gridExtra)
library(ggpubr)
library(survRatio)

## source functions
lung.time = lung$time
lung.cens = lung$status
gender = as.factor(lung$sex)
levels(gender) <- c("Male", "Female")
```

The `drsurv` function takes the survival time, censoring indicator and the factor level as inputs and returns the Kaplain-Meier estimated survivor functions with their corresponding confidence intervals. A `drsurv` object is created which contains the estimates of the survival ratio, the survival difference and pointwise (bootstrap) confidence bands. 

```{r}
fit1 <- drsurv(time = lung.time, status = lung.cens, factor = gender)
ls(fit1)
```

The `drsurv` object also includes the assigned confidence level, the factor levels, the number of bootstrap replicates and the p-value for the test of equality of survivr functions.

```{r, eval=FALSE}
head(fit1$surv)
```

```{r, echo=FALSE, results='asis'}
kable(head(signif(fit1$surv, 3)))
```

A plot of the survival ratio ($\frac{\hat{S_1}(t)}{\hat{S_2}(t)}$) with pointwise confidence bands can be generated using the `ggsurv` function:

```{r, warning=FALSE}
ggsurv(fit1) +
  ylab("Estimated Survival Ratio") +
  xlab("Follow Up Time (days)")
```

The default, plot displays the estimated survival ratio and 95% (pointwise) confidence interval. In addition, a reference line is drawn where the ratio is equal to 1 (to represent 'no difference' in the survival ratio) and time intervals coloured by whether or not the (pointwise) confidence bands include the reference. For example, there appears to be convincing evidence of a difference in survival prospects favoring females up to approximately 730 days.

The plot is generated as a `ggplot` object and allowing changes to axis labels, themes etc:

```{r, warning=FALSE}
ggsurv(fit1) +
  ylab("Estimated Survival Ratio") +
  xlab("Follow Up Time (days)") +
  theme_bw()
```

A plot of the survival difference ($\hat{S_1}(t)-\hat{S_2}(t)$) with pointwise confidence bands can be generated by setting `statistics = "diff"` as follows:

```{r, warning=FALSE}
ggsurv(fit1, statistics = "diff") +
  ylab("Estimated Difference in Survival") +
  xlab("Follow Up Time (days)")
```

The `ggsurv` function has the option to include a table of the number of subjects at risk over time:

```{r, warning=FALSE}
ggsurv(fit1, statistics = "diff",
       palette = c("blue"),
       xlab = "Time (days)", ylab = "Estimated Difference in Survival", 
       theme = "gray",
       table = TRUE)
```

A plot of the Kaplan-Meir estimated survivor functions ($\hat{S_1}(t)$ and $\hat{S_2}(t)$), accompanied with their confidence intervals and p-value from a log-rank test, can be generated by setting `statistics = "surv"`:

```{r, warning=FALSE}
ggsurv(fit1, statistics = "surv", p.value = TRUE) +
  ylab("Estimated Survival") +
  xlab("Follow Up Time (days)")
```

If required, the `ggsurv` function can provided a grid of the three plots by setting `statistics = "all"`.

```{r, warning=FALSE, fig.height=10, fig.width=12}
ggsurv(fit1, statistics = "all",
       table = TRUE)
```

### Example 2: Paired survival data

The diabetic retinopathy dataset from the `survival` package is used to illustrate the comparison of survival prospects for a paired design. The dataset includes time to loss of vision (in months) after laser coagulation as a treatment to delay diabetic retinopathy. Each patient has two observations in the data set as one eye was randomised to receive laser treatment with the other eye receiving no treatment. 

```{r, include=F}
ret.time = retinopathy$futime
ret.status = retinopathy$status
ret.treatment = as.factor(retinopathy$trt)
levels(ret.treatment) <- c("Control eye", "Treated eye")
ret.id = retinopathy$id
```

The `drsurv` function can be used for paired survival design to estimate the (marginal) survivor functions for each treatment, pairwise differences and ratios (with corresponding pointwise confidence bands based on a permutation test) by setting `paired=TRUE` and providing a variable to identify each pair.

```{r, eval=FALSE}
fit2 <- drsurv(ret.time, ret.status, ret.treatment, paired = TRUE, id = ret.id)
head(fit2$surv)
```

```{r, echo=FALSE, results='asis'}
fit2 <- drsurv(time = ret.time, status = ret.status, ret.treatment, paired = TRUE, id = ret.id)
kable(head(signif(fit2$surv, 3)))
```

A plot of the survival ratio can be generated while incorporating ggplot commands as required:

```{r, warning=FALSE}
p1 <- ggsurv(fit2, statistics = "ratio")
p1 + labs(title = "Estimated Survival Ratio for Time to Loss of Vision after Laser Coagulation",
          subtitle = "Ratio = (Control / Treated)",
          y = "Estimated Survival Ratio", 
          x = "Follow Up (Months)")  +
      theme(legend.position="bottom",
           legend.background = element_rect(fill="lightblue", linetype="solid"))
```

A (annotated) plot of the survival difference is as follows:

```{r, warning=FALSE}
p1 <- ggsurv(fit2, statistics = "diff")
p1 + labs(title = "Estimated Survival Difference for Time to Loss of Vision after Laser Coagulation",
          subtitle = "Difference = (Control - Treated)",
          y = "Estimated Survival Difference", 
          x = "Follow Up (Months)")  +
      theme(legend.position="bottom",
           legend.background = element_rect(fill="white", linetype="solid"))
```

## Reference
[1] Newell, J., Kay, J. W., & Aitchison, T. C. (2006). Survival ratio plots with permutation envelopes in survival data problems. Computers in biology and medicine, 36(5), 526-541.
